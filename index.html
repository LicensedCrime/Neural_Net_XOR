<html>
    <head></head>
    <body>
        <script>
            function sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
            function dsigmoid(x) { return x * (1 - x); }

            Array.prototype.print = function(title) {
                var num_y = this.length;
                var num_x = this[0].length;

                if(!title) {
                    title = "res";
                }

                var str = "[\n";

                if(num_x > 0) {
                    for(var y = 0; y < num_y; y++) {
                        for(var x = 0; x < num_x; x++) {
                            str += (" " + this[y][x]).padEnd(19);
                        }
                    }

                    str += "\n]";
                    console.log(title, str);
                    return;
                }

                if(num_y > 0) {
                    for(var x = 0; x < num_y; x++) {
                        str += (" " + this[x]).padEnd(19);
                    }

                    str += "\n]";
                    console.log(title, str);
                    return;
                }

                console.log(title, "[]");
            };

            Array.prototype.copyMat = function() {
                var tmp = [], index = 0;
                this.forEach(y => {
                    tmp.push([]);

                    y.forEach(x => tmp[index].push(x));

                    index++;
                });

                return tmp;
            };

            Array.prototype.dot = function(arr) {
                var arr_cols = arr[0].length;
                var arr_rows = arr.length;
                var num_rows = this.length;

                if(this[0].length != arr_rows) {
                    throw "rip dot" + this[0].length + " " + arr_rows;
                }

                var sum = 0;
                var out = [];
                for(var z = 0; z < num_rows; z++) {
                    out[z] = [];

                    for(var n = 0; n < arr_cols; n++) {
                        sum = 0;

                        for(var y = 0; y < arr_rows; y++) {
                            sum += this[z][y] * arr[y][n];
                        }

                        out[z][n] = sum;
                    }
                }

                return out;
            };

            Array.prototype.transpose = function() {
                var num_cols = this[0].length;
                var tmp = [], n = 0;
                while(n < num_cols) { n++; tmp.push([]); }

                for(var z = 0; z < num_cols; z++) {
                    for(var y = 0; y < this.length; y++) {
                        tmp[z].push(this[y][z]);
                    }
                }

                return tmp;
            };

            Array.prototype.random = function(rows, cols) {
                var out = [];
                for(var y = 0; y < rows; y++) {
                    out[y] = [];

                    for(var x = 0; x < cols; x++) {
                        out[y][x] = Math.random()
                    }
                }

                return out;
            };
        </script>

        <script>
            function ANN() {
                var weights = null;
                var layers = null;
                var deltas = null;
                var errors = null;

                var l_rate = 0.05;

                this.format = function(args) {
                    layers = [];
                    weights = [];

                    var prev_val = args[0];
                    for(var i = 1; i < args.length; i++) {
                        weights.push([].random(prev_val, args[i]));
                        prev_val = args[i];
                    }

                    return this;
                };

                this.feed = function(input) {
                    layers[0] = input.copyMat();
                    weights.forEach((w, i) => { 
                        layers[i+1] = layers[i].dot(w).map(row => row.map(x => sigmoid(x))); 
                    });
                };

                this.train = function(output) {
                    errors = [];
                    deltas = [];

                    var n = layers.length - 1;
                    errors[n] = output.map((row, i_row) => row.map((x, i_col) => x - layers[n][i_row][i_col]));
                    deltas[n] = errors[n].map((row, i_row) => row.map((x, i_col) => x * dsigmoid(layers[n][i_row][i_col])));

                    n--;
                    while(n > -1) {
                        errors[n] = layers[n+1].dot(weights[n].transpose());
                        deltas[n] = errors[n].map((row, i_row) => row.map((x, i_col) => x * dsigmoid(layers[n][i_row][i_col])));

                        n--;
                    }

                    var layer_t = null;
                    weights = weights.map((w, i) => {
                        layer_t = layers[i].transpose();
                        return w.map((row, i_row) => row.map((x, i_col) => x + l_rate * layer_t.dot(deltas[i+1])[i_row][i_col]));
                    });
                };

                this.get = function() { return layers[layers.length - 1]; };

                this.print_error = function() {
                    var e = errors[errors.length-1];
                    e.print("error");
                };
            }
        </script>

        <script>
            var nn = new ANN().format([8, 16, 8, 4]);

            var input = [[
                0,0,1,1, // value 1
                0,1,0,1  // value 2
            ]];

            var output = [[ 0,1,1,0 ]];

            var n = 20000;
            while(n > 0){
                n--;

                nn.feed(input);
                nn.train(output);

                if(n % 1000 == 0) {
                    nn.print_error();
                }
            }

            nn.feed(input);
            nn.get().print();
        </script>
    </body>
</html>